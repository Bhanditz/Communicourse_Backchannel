@(implicit req: RequestHeader,username: String, role: String, chatroomName: String,  allChatRooms: Iterable[String])

@main("room: "+ chatroomName ) {




    <div class="root">

        <div class="row root">

            @templates.chatroom_panel(req, username, role, chatroomName, allChatRooms)

            <div class="col s8 m9 l9 chatPanel grey lighten-2">
                <div id="chat"></div>
                <input class = "chatPanel__input" id="message" type="text" name ="message" placeholder="ENTER A MESSAGE"/>
            </div>

        </div>
    </div>





    <script>
            var user = "@username";
            var websocket = new WebSocket("@routes.Application.getChatroom(chatroomName).webSocketURL()");
            websocket.onmessage = function(msgFromSocket) {
                var m = JSON.parse(msgFromSocket.data);
                console.log(m);
                console.log(msgFromSocket);
                var isItMe = m.user === user ?  "myMessage" : "friendsMessage right";
                var whoSentMessage = m.autoGenerated ? "botMessage right" : isItMe;
                var messageClass = "'"+whoSentMessage+"'";
                $("#chat").append(
                        "<div class = 'messageWrapper clearfix'>"
                        +"<div class="+messageClass+">"
                        +"<span>"+"<strong>"+ m.user + ": " + "</strong>" + m.message.replace(/\n/g,"<br>")+"</span>"+"</div>"
                        +"</div>");
            };

            var stringBuffer="";
            var stringBufferIndex=0;
            var changeFlag="";

            $("input").on("keyup", function (e) {

                if(e.keyCode == 38) {
                    if(changeFlag=="down" && stringBufferIndex!=stringBuffer.split(";").length-2)stringBufferIndex-=1;
                    stringBufferIndex-=1;
                    if(stringBufferIndex>=-1){
                        document.getElementById("message").value=stringBuffer.split(";")[stringBufferIndex+1];
                    }
                    else {
                        stringBufferIndex+=1;
                        document.getElementById("message").value="";}
                    changeFlag="up";
                    return;
                }
                if(e.keyCode == 40) {
                    if(changeFlag=="up" && stringBufferIndex!=-1)stringBufferIndex+=1;
                    stringBufferIndex=stringBufferIndex+1;
                    if(stringBufferIndex<=stringBuffer.split(";").length-2){
                        document.getElementById("message").value=stringBuffer.split(";")[stringBufferIndex];
                    }
                    else {
                        stringBufferIndex=stringBufferIndex-1;
                        document.getElementById("message").value="";}
                    changeFlag="down";
                    return;
                }
                if(e.keyCode != 13) {
                    return;
                }

                stringBuffer=stringBuffer+(document.getElementById("message").value+";");
                stringBufferIndex=stringBuffer.split(";").length-2;

                var m = JSON.stringify({message: this.value, user: user, autoGenerated: false});
                this.value = "";
                console.log(m);
                websocket.send(m)
            });


    </script>

}
